{
  "calculation_contract": {
    "medication_quantity": {
      "rule": "Each month uses the same medication_quantity value (0-10) directly as the multiplier for medication_unit_fee",
      "formula": "monthly_medication_fee = medication_quantity * medication_unit_fee"
    },
    "visit_scheduling": {
      "rule": "Starting from next_followup_month (inclusive), schedule visits every followup_frequency_months within months 1-12",
      "examples": {
        "next_followup_month_3_frequency_3": [
          false,
          false,
          true,
          false,
          false,
          true,
          false,
          false,
          true,
          false,
          false,
          true
        ],
        "next_followup_month_1_frequency_2": [
          true,
          false,
          true,
          false,
          true,
          false,
          true,
          false,
          true,
          false,
          true,
          false
        ]
      }
    },
    "monthly_calculation": {
      "formula": "sum(visit_fees_scheduled_in_month) + (medication_quantity * medication_unit_fee)"
    },
    "annual_summary": {
      "annual_total": "sum of all 12 monthly totals",
      "monthly_average": "annual_total / 12, rounded to 2 decimals",
      "peak_months": "all months where monthly_total equals max(monthly_totals)"
    }
  },
  "test_cases": [
    {
      "case_id": "case_001_single_sopc_q1_med_q3",
      "description": "Single SOPC specialty, 1 medication unit, quarterly visits starting month 3",
      "inputs": {
        "specialties": [
          {
            "specialty_label": "內科",
            "service_type": "sopc",
            "followup_frequency_months": 3,
            "next_followup_month": 3,
            "medication_quantity": 1
          }
        ]
      },
      "expected": {
        "monthly_totals": [20, 20, 270, 20, 20, 270, 20, 20, 270, 20, 20, 270],
        "breakdown": {
          "visits": [0, 0, 250, 0, 0, 250, 0, 0, 250, 0, 0, 250],
          "medications": [20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20]
        },
        "annual_total": 1240,
        "monthly_average": 103.33,
        "peak_months": [3, 6, 9, 12],
        "peak_total": 270
      }
    },
    {
      "case_id": "case_002_single_sopc_q2_med_q2_start1",
      "description": "Single SOPC specialty, 2 medication units, bi-monthly visits starting month 1",
      "inputs": {
        "specialties": [
          {
            "specialty_label": "骨科",
            "service_type": "sopc",
            "followup_frequency_months": 2,
            "next_followup_month": 1,
            "medication_quantity": 2
          }
        ]
      },
      "expected": {
        "monthly_totals": [290, 40, 290, 40, 290, 40, 290, 40, 290, 40, 290, 40],
        "breakdown": {
          "visits": [250, 0, 250, 0, 250, 0, 250, 0, 250, 0, 250, 0],
          "medications": [40, 40, 40, 40, 40, 40, 40, 40, 40, 40, 40, 40]
        },
        "annual_total": 1980,
        "monthly_average": 165,
        "peak_months": [1, 3, 5, 7, 9, 11],
        "peak_total": 290
      }
    },
    {
      "case_id": "case_003_single_sopc_q4_med_q3",
      "description": "Single SOPC specialty, 3 medication units, quarterly visits starting month 4",
      "inputs": {
        "specialties": [
          {
            "specialty_label": "心臟科",
            "service_type": "sopc",
            "followup_frequency_months": 4,
            "next_followup_month": 4,
            "medication_quantity": 3
          }
        ]
      },
      "expected": {
        "monthly_totals": [60, 60, 60, 310, 60, 60, 60, 310, 60, 60, 60, 310],
        "breakdown": {
          "visits": [0, 0, 0, 250, 0, 0, 0, 250, 0, 0, 0, 250],
          "medications": [60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60]
        },
        "annual_total": 1470,
        "monthly_average": 122.5,
        "peak_months": [4, 8, 12],
        "peak_total": 310
      }
    },
    {
      "case_id": "case_004_two_specialties_sopc_mixed",
      "description": "Two SOPC specialties with different schedules and medication quantities",
      "inputs": {
        "specialties": [
          {
            "specialty_label": "內分泌科",
            "service_type": "sopc",
            "followup_frequency_months": 3,
            "next_followup_month": 2,
            "medication_quantity": 2
          },
          {
            "specialty_label": "腎科",
            "service_type": "sopc",
            "followup_frequency_months": 2,
            "next_followup_month": 1,
            "medication_quantity": 1
          }
        ]
      },
      "expected": {
        "monthly_totals": [310, 310, 310, 60, 560, 60, 310, 310, 310, 60, 560, 60],
        "breakdown": {
          "visits": [250, 250, 250, 0, 500, 0, 250, 250, 250, 0, 500, 0],
          "medications": [60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60, 60]
        },
        "annual_total": 3220,
        "monthly_average": 268.33,
        "peak_months": [5, 11],
        "peak_total": 560
      }
    },
    {
      "case_id": "case_005_gopc_only_q1_med",
      "description": "Single GOPC specialty with 1 medication unit, monthly visits",
      "inputs": {
        "specialties": [
          {
            "specialty_label": "普通科",
            "service_type": "gopc",
            "followup_frequency_months": 1,
            "next_followup_month": 1,
            "medication_quantity": 1
          }
        ]
      },
      "expected": {
        "monthly_totals": [155, 155, 155, 155, 155, 155, 155, 155, 155, 155, 155, 155],
        "breakdown": {
          "visits": [150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150],
          "medications": [5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5]
        },
        "annual_total": 1860,
        "monthly_average": 155,
        "peak_months": [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12],
        "peak_total": 155
      }
    },
    {
      "case_id": "case_006_mixed_sopc_gopc",
      "description": "One SOPC and one GOPC specialty with different schedules",
      "inputs": {
        "specialties": [
          {
            "specialty_label": "皮膚科",
            "service_type": "sopc",
            "followup_frequency_months": 6,
            "next_followup_month": 1,
            "medication_quantity": 0
          },
          {
            "specialty_label": "普通科",
            "service_type": "gopc",
            "followup_frequency_months": 2,
            "next_followup_month": 2,
            "medication_quantity": 2
          }
        ]
      },
      "expected": {
        "monthly_totals": [260, 160, 10, 160, 10, 160, 260, 160, 10, 160, 10, 160],
        "breakdown": {
          "visits": [250, 150, 0, 150, 0, 150, 250, 150, 0, 150, 0, 150],
          "medications": [10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10, 10]
        },
        "annual_total": 1520,
        "monthly_average": 126.67,
        "peak_months": [1, 7],
        "peak_total": 260
      }
    },
    {
      "case_id": "case_007_high_cost_multiple_specialties",
      "description": "Three SOPC specialties with high medication usage, testing ASC threshold",
      "inputs": {
        "specialties": [
          {
            "specialty_label": "心臟科",
            "service_type": "sopc",
            "followup_frequency_months": 2,
            "next_followup_month": 1,
            "medication_quantity": 3
          },
          {
            "specialty_label": "腎科",
            "service_type": "sopc",
            "followup_frequency_months": 3,
            "next_followup_month": 2,
            "medication_quantity": 3
          },
          {
            "specialty_label": "內分泌科",
            "service_type": "sopc",
            "followup_frequency_months": 3,
            "next_followup_month": 1,
            "medication_quantity": 2
          }
        ]
      },
      "expected": {
        "monthly_totals": [660, 410, 410, 410, 660, 160, 660, 410, 410, 410, 660, 160],
        "breakdown": {
          "visits": [500, 250, 250, 250, 500, 0, 500, 250, 250, 250, 500, 0],
          "medications": [160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160, 160]
        },
        "annual_total": 5420,
        "monthly_average": 451.67,
        "peak_months": [1, 5, 7, 11],
        "peak_total": 660
      }
    },
    {
      "case_id": "case_008_no_medication",
      "description": "Multiple specialties with no medication prescriptions",
      "inputs": {
        "specialties": [
          {
            "specialty_label": "外科",
            "service_type": "sopc",
            "followup_frequency_months": 4,
            "next_followup_month": 3,
            "medication_quantity": 0
          },
          {
            "specialty_label": "眼科",
            "service_type": "sopc",
            "followup_frequency_months": 6,
            "next_followup_month": 5,
            "medication_quantity": 0
          }
        ]
      },
      "expected": {
        "monthly_totals": [0, 0, 250, 0, 250, 0, 250, 0, 0, 0, 500, 0],
        "breakdown": {
          "visits": [0, 0, 250, 0, 250, 0, 250, 0, 0, 0, 500, 0],
          "medications": [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
        },
        "annual_total": 1250,
        "monthly_average": 104.17,
        "peak_months": [11],
        "peak_total": 500
      }
    },
    {
      "case_id": "case_009_asc_threshold_test_above",
      "description": "Testing annual total exceeding ASC cap (10000 HKD)",
      "inputs": {
        "specialties": [
          {
            "specialty_label": "心臟科",
            "service_type": "sopc",
            "followup_frequency_months": 1,
            "next_followup_month": 1,
            "medication_quantity": 3
          },
          {
            "specialty_label": "腎科",
            "service_type": "sopc",
            "followup_frequency_months": 1,
            "next_followup_month": 1,
            "medication_quantity": 3
          },
          {
            "specialty_label": "內分泌科",
            "service_type": "sopc",
            "followup_frequency_months": 1,
            "next_followup_month": 1,
            "medication_quantity": 3
          }
        ]
      },
      "expected": {
        "monthly_totals": [930, 930, 930, 930, 930, 930, 930, 930, 930, 930, 930, 930],
        "breakdown": {
          "visits": [750, 750, 750, 750, 750, 750, 750, 750, 750, 750, 750, 750],
          "medications": [180, 180, 180, 180, 180, 180, 180, 180, 180, 180, 180, 180]
        },
        "annual_total": 11160,
        "monthly_average": 930,
        "peak_months": [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12],
        "peak_total": 930
      }
    },
    {
      "case_id": "case_010_single_visit_per_year",
      "description": "Specialty with single visit in year (frequency 6, starting month 8)",
      "inputs": {
        "specialties": [
          {
            "specialty_label": "耳鼻喉科",
            "service_type": "sopc",
            "followup_frequency_months": 6,
            "next_followup_month": 8,
            "medication_quantity": 1
          }
        ]
      },
      "expected": {
        "monthly_totals": [20, 20, 20, 20, 20, 20, 20, 270, 20, 20, 20, 20],
        "breakdown": {
          "visits": [0, 0, 0, 0, 0, 0, 0, 250, 0, 0, 0, 0],
          "medications": [20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20]
        },
        "annual_total": 490,
        "monthly_average": 40.83,
        "peak_months": [8],
        "peak_total": 270
      }
    }
  ]
}
