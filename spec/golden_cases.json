{
  "calculation_contract": {
    "medication_units_by_tier": {
      "none": [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0],
      "low": [1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1],
      "medium": [1, 1, 2, 1, 1, 2, 1, 1, 2, 1, 1, 2],
      "high": [1, 2, 1, 2, 1, 3, 1, 2, 1, 2, 1, 3]
    },
    "visit_scheduling": {
      "rule": "Starting from next_followup_month (inclusive), schedule visits every followup_frequency_months within months 1-12",
      "examples": {
        "next_followup_month_3_frequency_3": [
          false,
          false,
          true,
          false,
          false,
          true,
          false,
          false,
          true,
          false,
          false,
          true
        ],
        "next_followup_month_1_frequency_2": [
          true,
          false,
          true,
          false,
          true,
          false,
          true,
          false,
          true,
          false,
          true,
          false
        ]
      }
    },
    "monthly_calculation": {
      "formula": "sum(visit_fees_scheduled_in_month) + (medication_units_in_month * medication_unit_fee)"
    },
    "annual_summary": {
      "annual_total": "sum of all 12 monthly totals",
      "monthly_average": "annual_total / 12, rounded to 2 decimals",
      "peak_months": "all months where monthly_total equals max(monthly_totals)"
    }
  },
  "test_cases": [
    {
      "case_id": "case_001_single_sopc_low_med_q3",
      "description": "Single SOPC specialty, low medication tier, quarterly visits starting month 3",
      "inputs": {
        "specialties": [
          {
            "specialty_label": "內科",
            "service_type": "sopc",
            "followup_frequency_months": 3,
            "next_followup_month": 3,
            "medication_tier": "low"
          }
        ]
      },
      "expected": {
        "monthly_totals": [20, 20, 270, 20, 20, 270, 20, 20, 270, 20, 20, 270],
        "breakdown": {
          "visits": [0, 0, 250, 0, 0, 250, 0, 0, 250, 0, 0, 250],
          "medications": [20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20]
        },
        "annual_total": 1240,
        "monthly_average": 103.33,
        "peak_months": [3, 6, 9, 12],
        "peak_total": 270
      }
    },
    {
      "case_id": "case_002_single_sopc_medium_med_q2_start1",
      "description": "Single SOPC specialty, medium medication tier, bi-monthly visits starting month 1",
      "inputs": {
        "specialties": [
          {
            "specialty_label": "骨科",
            "service_type": "sopc",
            "followup_frequency_months": 2,
            "next_followup_month": 1,
            "medication_tier": "medium"
          }
        ]
      },
      "expected": {
        "monthly_totals": [270, 20, 290, 20, 270, 40, 270, 20, 290, 20, 270, 40],
        "breakdown": {
          "visits": [250, 0, 250, 0, 250, 0, 250, 0, 250, 0, 250, 0],
          "medications": [20, 20, 40, 20, 20, 40, 20, 20, 40, 20, 20, 40]
        },
        "annual_total": 1820,
        "monthly_average": 151.67,
        "peak_months": [3, 9],
        "peak_total": 290
      }
    },
    {
      "case_id": "case_003_single_sopc_high_med_q4",
      "description": "Single SOPC specialty, high medication tier, quarterly visits starting month 4",
      "inputs": {
        "specialties": [
          {
            "specialty_label": "心臟科",
            "service_type": "sopc",
            "followup_frequency_months": 4,
            "next_followup_month": 4,
            "medication_tier": "high"
          }
        ]
      },
      "expected": {
        "monthly_totals": [20, 40, 20, 290, 20, 60, 20, 290, 20, 40, 20, 310],
        "breakdown": {
          "visits": [0, 0, 0, 250, 0, 0, 0, 250, 0, 0, 0, 250],
          "medications": [20, 40, 20, 40, 20, 60, 20, 40, 20, 40, 20, 60]
        },
        "annual_total": 1150,
        "monthly_average": 95.83,
        "peak_months": [12],
        "peak_total": 310
      }
    },
    {
      "case_id": "case_004_two_specialties_sopc_mixed",
      "description": "Two SOPC specialties with different schedules and medication tiers",
      "inputs": {
        "specialties": [
          {
            "specialty_label": "內分泌科",
            "service_type": "sopc",
            "followup_frequency_months": 3,
            "next_followup_month": 2,
            "medication_tier": "medium"
          },
          {
            "specialty_label": "腎科",
            "service_type": "sopc",
            "followup_frequency_months": 2,
            "next_followup_month": 1,
            "medication_tier": "low"
          }
        ]
      },
      "expected": {
        "monthly_totals": [290, 290, 310, 40, 540, 60, 290, 290, 310, 40, 540, 60],
        "breakdown": {
          "visits": [250, 250, 250, 0, 500, 0, 250, 250, 250, 0, 500, 0],
          "medications": [40, 40, 60, 40, 40, 60, 40, 40, 60, 40, 40, 60]
        },
        "annual_total": 3060,
        "monthly_average": 255,
        "peak_months": [5, 11],
        "peak_total": 540
      }
    },
    {
      "case_id": "case_005_gopc_only_low_med",
      "description": "Single GOPC specialty with low medication tier, monthly visits",
      "inputs": {
        "specialties": [
          {
            "specialty_label": "普通科",
            "service_type": "gopc",
            "followup_frequency_months": 1,
            "next_followup_month": 1,
            "medication_tier": "low"
          }
        ]
      },
      "expected": {
        "monthly_totals": [155, 155, 155, 155, 155, 155, 155, 155, 155, 155, 155, 155],
        "breakdown": {
          "visits": [150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150, 150],
          "medications": [5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5, 5]
        },
        "annual_total": 1860,
        "monthly_average": 155,
        "peak_months": [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12],
        "peak_total": 155
      }
    },
    {
      "case_id": "case_006_mixed_sopc_gopc",
      "description": "One SOPC and one GOPC specialty with different schedules",
      "inputs": {
        "specialties": [
          {
            "specialty_label": "皮膚科",
            "service_type": "sopc",
            "followup_frequency_months": 6,
            "next_followup_month": 1,
            "medication_tier": "none"
          },
          {
            "specialty_label": "普通科",
            "service_type": "gopc",
            "followup_frequency_months": 2,
            "next_followup_month": 2,
            "medication_tier": "medium"
          }
        ]
      },
      "expected": {
        "monthly_totals": [255, 155, 10, 155, 5, 160, 255, 155, 10, 155, 5, 160],
        "breakdown": {
          "visits": [250, 150, 0, 150, 0, 150, 250, 150, 0, 150, 0, 150],
          "medications": [5, 5, 10, 5, 5, 10, 5, 5, 10, 5, 5, 10]
        },
        "annual_total": 1480,
        "monthly_average": 123.33,
        "peak_months": [1, 7],
        "peak_total": 255
      }
    },
    {
      "case_id": "case_007_high_cost_multiple_specialties",
      "description": "Three SOPC specialties with high medication usage, testing ASC threshold",
      "inputs": {
        "specialties": [
          {
            "specialty_label": "心臟科",
            "service_type": "sopc",
            "followup_frequency_months": 2,
            "next_followup_month": 1,
            "medication_tier": "high"
          },
          {
            "specialty_label": "腎科",
            "service_type": "sopc",
            "followup_frequency_months": 3,
            "next_followup_month": 2,
            "medication_tier": "high"
          },
          {
            "specialty_label": "內分泌科",
            "service_type": "sopc",
            "followup_frequency_months": 3,
            "next_followup_month": 1,
            "medication_tier": "medium"
          }
        ]
      },
      "expected": {
        "monthly_totals": [560, 350, 330, 350, 560, 160, 560, 350, 330, 350, 560, 160],
        "breakdown": {
          "visits": [500, 250, 250, 250, 500, 0, 500, 250, 250, 250, 500, 0],
          "medications": [60, 100, 80, 100, 60, 160, 60, 100, 80, 100, 60, 160]
        },
        "annual_total": 4620,
        "monthly_average": 385,
        "peak_months": [1, 5, 7, 11],
        "peak_total": 560
      }
    },
    {
      "case_id": "case_008_no_medication",
      "description": "Multiple specialties with no medication prescriptions",
      "inputs": {
        "specialties": [
          {
            "specialty_label": "外科",
            "service_type": "sopc",
            "followup_frequency_months": 4,
            "next_followup_month": 3,
            "medication_tier": "none"
          },
          {
            "specialty_label": "眼科",
            "service_type": "sopc",
            "followup_frequency_months": 6,
            "next_followup_month": 5,
            "medication_tier": "none"
          }
        ]
      },
      "expected": {
        "monthly_totals": [0, 0, 250, 0, 250, 0, 250, 0, 0, 0, 500, 0],
        "breakdown": {
          "visits": [0, 0, 250, 0, 250, 0, 250, 0, 0, 0, 500, 0],
          "medications": [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0]
        },
        "annual_total": 1250,
        "monthly_average": 104.17,
        "peak_months": [11],
        "peak_total": 500
      }
    },
    {
      "case_id": "case_009_asc_threshold_test_above",
      "description": "Testing annual total exceeding ASC cap (10000 HKD)",
      "inputs": {
        "specialties": [
          {
            "specialty_label": "心臟科",
            "service_type": "sopc",
            "followup_frequency_months": 1,
            "next_followup_month": 1,
            "medication_tier": "high"
          },
          {
            "specialty_label": "腎科",
            "service_type": "sopc",
            "followup_frequency_months": 1,
            "next_followup_month": 1,
            "medication_tier": "high"
          },
          {
            "specialty_label": "內分泌科",
            "service_type": "sopc",
            "followup_frequency_months": 1,
            "next_followup_month": 1,
            "medication_tier": "high"
          }
        ]
      },
      "expected": {
        "monthly_totals": [810, 870, 810, 870, 810, 930, 810, 870, 810, 870, 810, 930],
        "breakdown": {
          "visits": [750, 750, 750, 750, 750, 750, 750, 750, 750, 750, 750, 750],
          "medications": [60, 120, 60, 120, 60, 180, 60, 120, 60, 120, 60, 180]
        },
        "annual_total": 10200,
        "monthly_average": 850,
        "peak_months": [6, 12],
        "peak_total": 930
      }
    },
    {
      "case_id": "case_010_single_visit_per_year",
      "description": "Specialty with single visit in year (frequency 6, starting month 8)",
      "inputs": {
        "specialties": [
          {
            "specialty_label": "耳鼻喉科",
            "service_type": "sopc",
            "followup_frequency_months": 6,
            "next_followup_month": 8,
            "medication_tier": "low"
          }
        ]
      },
      "expected": {
        "monthly_totals": [20, 20, 20, 20, 20, 20, 20, 270, 20, 20, 20, 20],
        "breakdown": {
          "visits": [0, 0, 0, 0, 0, 0, 0, 250, 0, 0, 0, 0],
          "medications": [20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20]
        },
        "annual_total": 490,
        "monthly_average": 40.83,
        "peak_months": [8],
        "peak_total": 270
      }
    }
  ]
}
